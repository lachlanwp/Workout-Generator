name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests with coverage
      run: npm test -- --coverage
    
    - name: Extract coverage percent
        run: |
          node <<'EOF'
          const fs = require('fs');
          const summary = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf-8'));
          const pct = summary.total.statements.pct;
          const badge = {
            schemaVersion: 1,
            label: "coverage",
            message: `${pct}%`,
            color: pct > 90 ? "brightgreen" : pct > 75 ? "yellow" : "red"
          };
          fs.mkdirSync('.badge', { recursive: true });
          fs.writeFileSync('.badge/coverage.json', JSON.stringify(badge));
          EOF

    - name: Upload badge to `gh-pages`
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: gh-pages
        publish_dir: .badge
        destination_dir: badges  # /badges/coverage.json